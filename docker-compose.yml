version: "3.8"

services:
  discord-music-bot:
    build: .
    image: benminer/discord-music-bot:latest
    container_name: discord-music-bot
    restart: always
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          memory: 512M
    environment:
      - RELEASE=true
      - PORT=8080
      - GIN_MODE=release
      - DATABASE_ENABLED=true
      - DATABASE_PATH=/app/data/database.db
      - DISCORD_APP_ID=${DISCORD_APP_ID}
      - DISCORD_PUBLIC_KEY=${DISCORD_PUBLIC_KEY}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - ENFORCE_VOICE_CHANNEL=${ENFORCE_VOICE_CHANNEL}
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_ENABLED=${GEMINI_ENABLED}
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
      - NGROK_DOMAIN=${NGROK_DOMAIN}
      - SENTRY_DSN=${SENTRY_DSN}
      - SPOTIFY_ENABLED=${SPOTIFY_ENABLED}
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
    volumes:
      - bot-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 5s

volumes:
  bot-data:
